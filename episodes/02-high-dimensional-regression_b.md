---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 02-high-dimensional-regression_b.md in _episodes_rmd/
title: "Stepwise feature selection for regression"
teaching: 0
exercises: 0
questions:
- "Why would we want to find a subset of features
  that are associated with an outcome?"
- "How can we iteratively find a good subset of our features
  variables to use for regression?"
- "What are some risks and downsides of iterative feature
  selection?"
objectives:
- "Understand multiple regression in a biomedical context."
- "Understand how to fit a stepwise regression model."
keypoints:
- "Sets of features can be more predictive and provide
  a better explanation than a single feature alone."
- "Stepwise regression allows us to find a set of features that
  are associated with an outcome (eg, age)."
- "Stepwise regression will tend to retain only one
  feature out of many that are correlated."
- "Stepwise regression is not very efficient."
math: yes
---





In the previous 

Another way of modelling these data is to model age as 

$$
    y_j = \beta_0 + \beta_1 X_1 + \dots \beta_p X_p + \epsilon_j
$$



~~~
suppressPackageStartupMessages({
    library("glmnet")
    library("limma")
    library("minfi")
    library("here")
    library("broom")
})

if (!file.exists(here("data/methylation.rds"))) {
    source(here("data/methylation.R"))
}
norm <- readRDS(here("data/methylation.rds"))

lim <- norm
y <- lim$Age
X <- getM(lim)
~~~
{: .language-r}

However when the number of predictors is greater than the number of samples
(basically always true in genetics) it isn't possible to include everything!

There are some techniques that you can use to find a set of predictors!

- screening (correlation etc): bad, don't do
- screening (variance): not necessarily bad if the screening variable is sensible
- forward/reverse/best subset selection


~~~
if (!file.exists(here("data/synthetic.rds"))) {
    source(here("data/synthetic.R"))
}
synthetic <- readRDS(here("data/synthetic.rds"))
~~~
{: .language-r}





~~~
X <- assay(synthetic)
y <- synthetic$age
beta <- rowData(synthetic)$true_beta
names(beta) <- rownames(synthetic)
## challenge 3: fit y on x univariate
## compare with true betas
cc <- sapply(seq_len(nrow(X)), function(i) {
    coef(lm(y ~ X[i, ]))[[2]]
})
plot(cc, beta, pch = 19, cex = 0.5)
abline(0, 1)
abline(v = 0, lty = "dashed", col = "firebrick")
abline(h = 0, lty = "dashed", col = "firebrick")
~~~
{: .language-r}

<img src="../fig/rmd-02b-unnamed-chunk-4-1.png" title="plot of chunk unnamed-chunk-4" alt="plot of chunk unnamed-chunk-4" width="612" style="display: block; margin: auto;" />




> ## Exercise
> Perform forward subset selection on the methylation data.
> 
> 
> > ## Solution
> > 
> > 
> {: .solution}
{: .challenge}




~~~
## challenge 4: forward selection
## compare with true betas
xy <- as.data.frame(cbind(t(X), y = y))
int <- lm(y ~ 1, data = xy)
all <- lm(y ~ . + 0, data = xy)
forward <- step(
    int,
    scope = list(upper = formula(all), lower = formula(int)),
    direction = "forward",
    trace = 0
)
forward$anova
~~~
{: .language-r}



~~~
           Step Df     Deviance Resid. Df  Resid. Dev          AIC
1               NA           NA        99 4381.160000  379.9898623
2  + feature_69 -1 805.49844982        98 3575.661550  361.6735301
3  + feature_67 -1 681.77204532        97 2893.889505  342.5186540
4  + feature_63 -1 377.26187460        96 2516.627630  330.5504856
5  + feature_13 -1 285.36307639        95 2231.264554  320.5153582
6   + feature_8 -1 322.40367076        94 1908.860883  306.9091761
7   + feature_5 -1 225.21050806        93 1683.650375  296.3549371
8  + feature_27 -1 222.33057654        92 1461.319799  284.1925092
9  + feature_86 -1 184.95680129        91 1276.362997  272.6599718
10 + feature_15 -1 162.20223134        90 1114.160766  261.0686538
11 + feature_34 -1 102.09342043        89 1012.067345  253.4580209
12 + feature_92 -1  95.36872290        88  916.698623  245.5608576
13 + feature_72 -1  79.32746169        87  837.371161  238.5097228
14 + feature_41 -1  78.66749596        86  758.703665  230.6441087
15 + feature_43 -1  94.72003556        85  663.983629  219.3087309
16 + feature_35 -1 142.51894593        84  521.464683  197.1471365
17 + feature_88 -1 105.74083594        83  415.723847  176.4851026
18 + feature_73 -1  64.06201756        82  351.661830  161.7499817
19 + feature_60 -1  65.02061182        81  286.641218  143.3061137
20 + feature_78 -1  40.68352395        80  245.957694  129.9989360
21 + feature_93 -1  29.02844597        79  216.929248  119.4401069
22 + feature_49 -1  38.06968333        78  178.859565  102.1430758
23 + feature_97 -1  37.59796871        77  141.261596   80.5443277
24 + feature_52 -1  27.63699462        76  113.624602   60.7729859
25 + feature_59 -1  25.68429296        75   87.940309   37.1488086
26 + feature_45 -1  20.55208482        74   67.388224   12.5300094
27  + feature_2 -1   8.71379530        73   58.674428    0.6833814
28 + feature_21 -1   4.61131779        72   54.063111   -5.5018106
29 + feature_77 -1   3.43579960        71   50.627311  -10.0679012
30 + feature_85 -1   3.49677695        70   47.130534  -15.2249113
31 + feature_95 -1   3.34850132        69   43.782033  -20.5946664
32 + feature_24 -1   2.99479587        68   40.787237  -25.6800975
33 + feature_20 -1   2.29423999        67   38.492997  -29.4693860
34 + feature_25 -1   1.43836905        66   37.054628  -31.2776934
35 + feature_42 -1   1.74024738        65   35.314380  -34.0879926
36 + feature_55 -1   2.22644425        64   33.087936  -38.6001435
37 + feature_29 -1   2.14837923        63   30.939557  -43.3134659
38 + feature_91 -1   1.88998461        62   29.049572  -47.6166423
39 + feature_83 -1   1.24610705        61   27.803465  -50.0009521
40 + feature_46 -1   1.24447606        60   26.558989  -52.5801916
41 + feature_23 -1   1.34416863        59   25.214821  -55.7738243
42 + feature_37 -1   0.94803685        58   24.266784  -57.6061693
43 + feature_70 -1   0.99294379        57   23.273840  -59.7840203
44 + feature_44 -1   1.28919442        56   21.984646  -63.4825904
45 + feature_12 -1   1.57266035        55   20.411985  -68.9047946
46 + feature_57 -1   0.91185003        54   19.500135  -71.4748787
47 + feature_16 -1   0.84491214        53   18.655223  -73.9044022
48 + feature_58 -1   0.86520331        52   17.790020  -76.6532574
49 + feature_33 -1   0.73441837        51   17.055601  -78.8691509
50 + feature_71 -1   0.54107141        50   16.514530  -80.0929588
51 + feature_31 -1   0.67294040        49   15.841590  -82.2531453
52 + feature_81 -1   0.56823414        48   15.273355  -83.9060350
53 + feature_56 -1   0.57683231        47   14.696523  -85.7559242
54  + feature_3 -1   0.67345202        46   14.023071  -88.4466276
55 + feature_11 -1   0.66005406        45   13.363017  -91.2679216
56  + feature_6 -1   0.63430620        44   12.728711  -94.1310047
57  + feature_4 -1   0.31320024        43   12.415511  -94.6223639
58 + feature_48 -1   0.28506229        42   12.130448  -94.9451504
59 + feature_17 -1   0.35589958        41   11.774549  -95.9229871
60 + feature_53 -1   0.43008709        40   11.344462  -97.6440521
61 + feature_28 -1   0.36165418        39   10.982807  -98.8839093
62 + feature_36 -1   0.45102750        38   10.531780 -101.0772836
63 + feature_74 -1   0.48572854        37   10.046051 -103.7990521
64 + feature_76 -1   0.52651432        36    9.519537 -107.1823961
65 + feature_50 -1   0.47967521        35    9.039862 -110.3526288
66 + feature_38 -1   0.38319108        34    8.656671 -112.6839969
67 + feature_51 -1   0.37525660        33    8.281414 -115.1156433
68 + feature_47 -1   0.34872117        32    7.932693 -117.4177606
69 + feature_94 -1   0.32743961        31    7.605253 -119.6330936
70 + feature_22 -1   0.33900317        30    7.266250 -122.1929809
71 + feature_90 -1   0.45219026        29    6.814060 -126.6182059
72 + feature_62 -1   0.25015033        28    6.563910 -128.3583773
73 + feature_61 -1   0.43663550        27    6.127274 -133.2420203
74 + feature_39 -1   0.37011191        26    5.757162 -137.4725494
75 + feature_40 -1   0.33411900        25    5.423043 -141.4513039
76 + feature_80 -1   0.15605797        24    5.266985 -142.3712036
77  + feature_9 -1   0.19259704        23    5.074388 -144.0964209
78 + feature_64 -1   0.16794163        22    4.906447 -145.4620207
79  + feature_7 -1   0.24246321        21    4.663983 -148.5300292
80 + feature_19 -1   0.35155901        20    4.312424 -154.3669931
81 + feature_54 -1   0.22792284        19    4.084502 -157.7970478
82 + feature_65 -1   0.19181264        18    3.892689 -160.6070024
83 + feature_87 -1   0.20729918        17    3.685390 -164.0793898
84 + feature_66 -1   0.20077256        16    3.484617 -167.6811991
85 + feature_30 -1   0.21153396        15    3.273083 -171.9437760
86 + feature_98 -1   0.10271800        14    3.170365 -173.1323389
87 + feature_68 -1   0.17898006        13    2.991385 -176.9433638
88  + feature_1 -1   0.11532692        12    2.876058 -178.8749494
89 + feature_84 -1   0.07912626        11    2.796932 -179.6647090
90 + feature_32 -1   0.12391134        10    2.673021 -182.1961025
91 + feature_14 -1   0.07358580         9    2.599435 -182.9876131
92 + feature_96 -1   0.09039892         8    2.509036 -184.5271601
93 + feature_75 -1   0.06864486         7    2.440391 -185.3011889
~~~
{: .output}



~~~
plot(coef(forward), beta[names(coef(forward))])
abline(0, 1)
abline(v = 0, lty = "dashed", col = "firebrick")
abline(h = 0, lty = "dashed", col = "firebrick")
~~~
{: .language-r}

<img src="../fig/rmd-02b-unnamed-chunk-5-1.png" title="plot of chunk unnamed-chunk-5" alt="plot of chunk unnamed-chunk-5" width="612" style="display: block; margin: auto;" />


~~~
## note about backward/both, not a challenge
all <- lm(y ~ . + 0, data = xy)
backward <- step(
    all,
    scope = formula(all),
    direction = "backward",
    trace = 0
)
backward$anova
~~~
{: .language-r}



~~~
           Step Df     Deviance Resid. Df Resid. Dev       AIC
1               NA           NA         1   2.292589 -179.5488
2  - feature_64  1 2.009393e-06         2   2.292591 -181.5487
3  - feature_36  1 1.014821e-06         3   2.292592 -183.5487
4  - feature_91  1 2.107379e-04         4   2.292803 -185.5395
5  - feature_19  1 8.444162e-04         5   2.293648 -187.5027
6  - feature_75  1 5.846322e-04         6   2.294232 -189.4772
7  - feature_24  1 1.579949e-02         7   2.310032 -190.7909
8   - feature_6  1 1.233750e-02         8   2.322369 -192.2582
9  - feature_47  1 1.967760e-02         9   2.342047 -193.4145
10 - feature_26  1 1.366514e-02        10   2.355712 -194.8327
11 - feature_12  1 3.663489e-02        11   2.392347 -195.2895
~~~
{: .output}



~~~
plot(coef(backward), beta[names(coef(backward))])
abline(0, 1)
abline(v = 0, lty = "dashed", col = "firebrick")
abline(h = 0, lty = "dashed", col = "firebrick")
~~~
{: .language-r}

<img src="../fig/rmd-02b-unnamed-chunk-6-1.png" title="plot of chunk unnamed-chunk-6" alt="plot of chunk unnamed-chunk-6" width="612" style="display: block; margin: auto;" />


{% include links.md %}
