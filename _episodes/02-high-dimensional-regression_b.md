---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 02-high-dimensional-regression_b.md in _episodes_rmd/
title: "Stepwise feature selection for regression"
teaching: 0
exercises: 0
questions:
- "Why would we want to find a subset of features
  that are associated with an outcome?"
- "How can we iteratively find a good subset of our features
  variables to use for regression?"
- "What are some risks and downsides of iterative feature
  selection?"
objectives:
- "Understand multiple regression in a biomedical context."
- "Understand how to fit a stepwise regression model."
keypoints:
- "Sets of features can be more predictive and provide
  a better explanation than a single feature alone."
- "Stepwise regression allows us to find a set of features that
  are associated with an outcome (eg, age)."
- "Stepwise regression will tend to retain only one
  feature out of many that are correlated."
- "Stepwise regression is not very efficient."
math: yes
---





In the previous 

Another way of modelling these data is to model age as 

$$
    y_j = \beta_0 + \beta_1 X_1 + \dots \beta_p X_p + \epsilon_j
$$



~~~
suppressPackageStartupMessages({
    library("glmnet")
    library("limma")
    library("minfi")
    library("here")
    library("broom")
})

if (!file.exists(here("data/methylation.rds"))) {
    source(here("data/methylation.R"))
}
norm <- readRDS(here("data/methylation.rds"))

lim <- norm
y <- lim$Age
X <- getM(lim)
~~~
{: .language-r}

However when the number of predictors is greater than the number of samples
(basically always true in genetics) it isn't possible to include everything!

There are some techniques that you can use to find a set of predictors!

- screening (correlation etc): bad, don't do
- screening (variance): not necessarily bad if the screening variable is sensible
- forward/reverse/best subset selection


~~~
if (!file.exists(here("data/synthetic.rds"))) {
    source(here("data/synthetic.R"))
}
synthetic <- readRDS(here("data/synthetic.rds"))
~~~
{: .language-r}





~~~
X <- assay(synthetic)
y <- synthetic$age
beta <- rowData(synthetic)$true_beta
names(beta) <- rownames(synthetic)
## challenge 3: fit y on x univariate
## compare with true betas
cc <- sapply(seq_len(nrow(X)), function(i) {
    coef(lm(y ~ X[i, ]))[[2]]
})
plot(cc, beta, pch = 19, cex = 0.5)
abline(0, 1)
abline(v = 0, lty = "dashed", col = "firebrick")
abline(h = 0, lty = "dashed", col = "firebrick")
~~~
{: .language-r}

<img src="../fig/rmd-02b-unnamed-chunk-4-1.png" title="plot of chunk unnamed-chunk-4" alt="plot of chunk unnamed-chunk-4" width="612" style="display: block; margin: auto;" />




> ## Exercise
> Perform forward subset selection on the methylation data.
> 
> 
> > ## Solution
> > 
> > 
> {: .solution}
{: .challenge}




~~~
## challenge 4: forward selection
## compare with true betas
xy <- as.data.frame(cbind(t(X), y = y))
int <- lm(y ~ 1, data = xy)
all <- lm(y ~ . + 0, data = xy)
forward <- step(
    int,
    scope = list(upper = formula(all), lower = formula(int)),
    direction = "forward",
    trace = 0
)
forward$anova
~~~
{: .language-r}



~~~
           Step Df     Deviance Resid. Df   Resid. Dev          AIC
1               NA           NA        99 4250.0400000  376.9513488
2  + feature_61 -1 1.014871e+03        98 3235.1689201  351.6666236
3  + feature_44 -1 6.544800e+02        97 2580.6889329  331.0641485
4  + feature_48 -1 4.631696e+02        96 2117.5193183  313.2830364
5  + feature_73 -1 3.770129e+02        95 1740.5063840  295.6761189
6  + feature_85 -1 3.610507e+02        94 1379.4556580  274.4274064
7  + feature_58 -1 2.556056e+02        93 1123.8500526  255.9345430
8  + feature_95 -1 1.783620e+02        92  945.4880569  240.6531071
9  + feature_81 -1 1.531277e+02        91  792.3603262  224.9846060
10  + feature_5 -1 1.417282e+02        90  650.6321078  207.2774178
11  + feature_7 -1 1.590027e+02        89  491.6293780  181.2554950
12 + feature_66 -1 9.967403e+01        88  391.9553529  160.5977752
13 + feature_63 -1 7.550327e+01        87  316.4520826  141.2001646
14 + feature_89 -1 9.666517e+01        86  219.7869128  106.7488313
15 + feature_49 -1 7.181174e+01        85  147.9751682   69.1874292
16 + feature_64 -1 2.163344e+01        84  126.3417331   55.3820217
17 + feature_13 -1 2.297696e+01        83  103.3647743   37.3094044
18 + feature_12 -1 1.295215e+01        82   90.4126271   25.9213752
19 + feature_20 -1 1.069236e+01        81   79.7202670   15.3353659
20 + feature_32 -1 5.152937e+00        80   74.5673302   10.6532292
21 + feature_83 -1 6.388625e+00        79   68.1787049    3.6962086
22 + feature_18 -1 4.022981e+00        78   64.1557236   -0.3856877
23 + feature_98 -1 4.783466e+00        77   59.3722575   -6.1343113
24 + feature_94 -1 3.799749e+00        76   55.5725089  -10.7481552
25 + feature_42 -1 3.461692e+00        75   52.1108164  -15.1797651
26 + feature_38 -1 2.665420e+00        74   49.4453961  -18.4301234
27 + feature_86 -1 2.717272e+00        73   46.7281237  -22.0823981
28  + feature_8 -1 2.506386e+00        72   44.2217379  -25.5953709
29 + feature_34 -1 2.703425e+00        71   41.5183133  -29.9035573
30 + feature_62 -1 3.326762e+00        70   38.1915517  -36.2555853
31 + feature_40 -1 1.168128e+00        69   37.0234233  -37.3619410
32 + feature_22 -1 1.346620e+00        68   35.6768031  -39.0669481
33 + feature_36 -1 1.046422e+00        67   34.6303812  -40.0438821
34 + feature_16 -1 1.116954e+00        66   33.5134268  -41.3224027
35 + feature_23 -1 1.201281e+00        65   32.3121457  -42.9726998
36 + feature_87 -1 1.125413e+00        64   31.1867323  -44.5177427
37  + feature_2 -1 1.357343e+00        63   29.8293896  -46.9676049
38 + feature_54 -1 9.268524e-01        62   28.9025372  -48.1240802
39 + feature_68 -1 8.166117e-01        61   28.0859256  -48.9901605
40 + feature_29 -1 8.292753e-01        60   27.2566502  -49.9872650
41 + feature_24 -1 1.064344e+00        59   26.1923066  -51.9704459
42  + feature_1 -1 8.253285e-01        58   25.3669781  -53.1721932
43 + feature_33 -1 6.591949e-01        57   24.7077832  -53.8051884
44 + feature_91 -1 1.110106e+00        56   23.5976773  -56.4021899
45 + feature_14 -1 5.563048e-01        55   23.0413725  -56.7878781
46 + feature_10 -1 5.706805e-01        54   22.4706920  -57.2958303
47 + feature_51 -1 8.404394e-01        53   21.6302526  -59.1077268
48 + feature_59 -1 7.054097e-01        52   20.9248429  -60.4233079
49 + feature_92 -1 1.080986e+00        51   19.8438571  -63.7275693
50 + feature_39 -1 7.911910e-01        50   19.0526661  -65.7963143
51 + feature_52 -1 6.937438e-01        49   18.3589223  -67.5054500
52 + feature_30 -1 9.367945e-01        48   17.4221278  -70.7429074
53 + feature_76 -1 1.039053e+00        47   16.3830746  -74.8921422
54 + feature_43 -1 1.259044e+00        46   15.1240305  -80.8885284
55 + feature_90 -1 1.118966e+00        45   14.0050649  -86.5751144
56 + feature_57 -1 7.050433e-01        44   13.3000216  -89.7404527
57 + feature_28 -1 8.969209e-01        43   12.4031007  -94.7223689
58 + feature_37 -1 1.039313e+00        42   11.3637873 -101.4738442
59 + feature_93 -1 1.042011e+00        41   10.3217765 -109.0914302
60 + feature_75 -1 1.066964e+00        40    9.2548126 -118.0026490
61 + feature_77 -1 5.196489e-01        39    8.7351637 -121.7813505
62 + feature_50 -1 7.494539e-01        38    7.9857098 -128.7516519
63 + feature_21 -1 4.658816e-01        37    7.5198282 -132.7626899
64 + feature_79 -1 6.440307e-01        36    6.8757975 -139.7162549
65 + feature_65 -1 4.966902e-01        35    6.3791073 -145.2142027
66 + feature_88 -1 6.294161e-01        34    5.7496911 -153.6024053
67 + feature_47 -1 5.496794e-01        33    5.2000117 -161.6509303
68 + feature_25 -1 3.308760e-01        32    4.8691357 -166.2253738
69 + feature_35 -1 3.215858e-01        31    4.5475499 -171.0581571
70 + feature_26 -1 2.264299e-01        30    4.3211200 -174.1655559
71 + feature_80 -1 2.253059e-01        29    4.0958141 -177.5204685
72 + feature_71 -1 2.199295e-01        28    3.8758846 -181.0396266
73  + feature_3 -1 2.867186e-01        27    3.5891660 -186.7250310
74 + feature_53 -1 2.803463e-01        26    3.3088197 -192.8578641
75 + feature_27 -1 1.968718e-01        25    3.1119479 -196.9921329
76 + feature_55 -1 8.309514e-02        24    3.0288527 -197.6986274
77 + feature_84 -1 1.016671e-01        23    2.9271856 -199.1128775
78  + feature_6 -1 1.019000e-01        22    2.8252856 -200.6560729
79 + feature_82 -1 1.128119e-01        21    2.7124737 -202.7309179
80 + feature_19 -1 1.170601e-01        20    2.5954135 -205.1424328
81 + feature_15 -1 1.958208e-01        19    2.3995928 -210.9871142
82 + feature_41 -1 2.572298e-01        18    2.1423630 -220.3260771
83 + feature_70 -1 8.558466e-02        17    2.0567783 -222.4029352
84 + feature_69 -1 6.418687e-02        16    1.9925914 -223.5734160
85  + feature_4 -1 5.847755e-02        15    1.9341139 -224.5520896
86 + feature_46 -1 1.159840e-01        14    1.8181299 -228.7361759
87 + feature_78 -1 9.744069e-02        13    1.7206892 -232.2445293
88 + feature_31 -1 1.799638e-01        12    1.5407254 -241.2916850
89 + feature_67 -1 2.043862e-01        11    1.3363392 -253.5236256
90 + feature_72 -1 3.106078e-01        10    1.0257314 -277.9764249
91 + feature_96 -1 2.161182e-01         9    0.8096133 -299.6368787
92 + feature_45 -1 1.907246e-01         8    0.6188886 -324.5000151
93 + feature_60 -1 1.391642e-01         7    0.4797244 -347.9713687
94  + feature_9 -1 7.035521e-02         6    0.4093692 -361.8308047
95 + feature_97 -1 1.251394e-01         5    0.2842298 -396.3142441
96 + feature_17 -1 2.666103e-02         4    0.2575688 -404.1638744
97 + feature_11 -1 7.220464e-02         3    0.1853641 -435.0603332
98 + feature_74 -1 3.171129e-02         2    0.1536528 -451.8229754
99 + feature_56 -1 1.749797e-02         1    0.1361549 -461.9132556
~~~
{: .output}



~~~
plot(coef(forward), beta[names(coef(forward))])
abline(0, 1)
abline(v = 0, lty = "dashed", col = "firebrick")
abline(h = 0, lty = "dashed", col = "firebrick")
~~~
{: .language-r}

<img src="../fig/rmd-02b-unnamed-chunk-5-1.png" title="plot of chunk unnamed-chunk-5" alt="plot of chunk unnamed-chunk-5" width="612" style="display: block; margin: auto;" />


~~~
## note about backward/both, not a challenge
all <- lm(y ~ . + 0, data = xy)
backward <- step(
    all,
    scope = formula(all),
    direction = "backward",
    trace = 0
)
backward$anova
~~~
{: .language-r}



~~~
          Step Df     Deviance Resid. Df Resid. Dev       AIC
1              NA           NA         1  0.1361549 -461.9133
2 - feature_34  1 0.0002903893         2  0.1364452 -463.7002
3 - feature_66  1 0.0001585834         3  0.1366038 -465.5840
4 - feature_20  1 0.0011963596         4  0.1378002 -466.7121
~~~
{: .output}



~~~
plot(coef(backward), beta[names(coef(backward))])
abline(0, 1)
abline(v = 0, lty = "dashed", col = "firebrick")
abline(h = 0, lty = "dashed", col = "firebrick")
~~~
{: .language-r}

<img src="../fig/rmd-02b-unnamed-chunk-6-1.png" title="plot of chunk unnamed-chunk-6" alt="plot of chunk unnamed-chunk-6" width="612" style="display: block; margin: auto;" />


{% include links.md %}
