---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 02-high-dimensional-regression_b.md in _episodes_rmd/
title: "Stepwise feature selection for regression"
teaching: 0
exercises: 0
questions:
- "Why would we want to find a subset of features
  that are associated with an outcome?"
- "How can we iteratively find a good subset of our features
  variables to use for regression?"
- "What are some risks and downsides of iterative feature
  selection?"
objectives:
- "Understand multiple regression in a biomedical context."
- "Understand how to fit a stepwise regression model."
keypoints:
- "Sets of features can be more predictive and provide
  a better explanation than a single feature alone."
- "Stepwise regression allows us to find a set of features that
  are associated with an outcome (eg, age)."
- "Stepwise regression will tend to retain only one
  feature out of many that are correlated."
- "Stepwise regression is not very efficient."
math: yes
---





In the previous 

Another way of modelling these data is to model age as 

$$
    y_j = \beta_0 + \beta_1 X_1 + \dots \beta_p X_p + \epsilon_j
$$



~~~
suppressPackageStartupMessages({
    library("glmnet")
    library("limma")
    library("minfi")
    library("here")
    library("broom")
})

if (!file.exists(here("data/methylation.rds"))) {
    source(here("data/methylation.R"))
}
norm <- readRDS(here("data/methylation.rds"))

lim <- norm
y <- lim$Age
X <- getM(lim)
~~~
{: .language-r}

However when the number of predictors is greater than the number of samples
(basically always true in genetics) it isn't possible to include everything!

There are some techniques that you can use to find a set of predictors!

- screening (correlation etc): bad, don't do
- screening (variance): not necessarily bad if the screening variable is sensible
- forward/reverse/best subset selection


~~~
if (!file.exists(here("data/synthetic.rds"))) {
    source(here("data/synthetic.R"))
}
synthetic <- readRDS(here("data/synthetic.rds"))
~~~
{: .language-r}





~~~
X <- assay(synthetic)
y <- synthetic$age
beta <- rowData(synthetic)$true_beta
names(beta) <- rownames(synthetic)
## challenge 3: fit y on x univariate
## compare with true betas
cc <- sapply(seq_len(nrow(X)), function(i) {
    coef(lm(y ~ X[i, ]))[[2]]
})
plot(cc, beta, pch = 19, cex = 0.5)
abline(0, 1)
abline(v = 0, lty = "dashed", col = "firebrick")
abline(h = 0, lty = "dashed", col = "firebrick")
~~~
{: .language-r}

<img src="../fig/rmd-02b-unnamed-chunk-4-1.png" title="plot of chunk unnamed-chunk-4" alt="plot of chunk unnamed-chunk-4" width="612" style="display: block; margin: auto;" />




> ## Exercise
> Perform forward subset selection on the methylation data.
> 
> 
> > ## Solution
> > 
> > 
> {: .solution}
{: .challenge}




~~~
## challenge 4: forward selection
## compare with true betas
xy <- as.data.frame(cbind(t(X), y = y))
int <- lm(y ~ 1, data = xy)
all <- lm(y ~ . + 0, data = xy)
forward <- step(
    int,
    scope = list(upper = formula(all), lower = formula(int)),
    direction = "forward",
    trace = 0
)
forward$anova
~~~
{: .language-r}



~~~
           Step Df     Deviance Resid. Df   Resid. Dev          AIC
1               NA           NA        99 5164.0000000  396.4296566
2   + feature_6 -1 1.176223e+03        98 3987.7766371  372.5818935
3  + feature_49 -1 8.564542e+02        97 3131.3223972  350.4040499
4  + feature_13 -1 8.134535e+02        96 2317.8689135  322.3233285
5  + feature_27 -1 7.242958e+02        95 1593.5731086  286.8563826
6  + feature_64 -1 2.155694e+02        94 1378.0037533  274.3220989
7  + feature_72 -1 1.926578e+02        93 1185.3459878  261.2619798
8  + feature_26 -1 1.635466e+02        92 1021.7993722  248.4150257
9  + feature_75 -1 1.707941e+02        91  851.0053027  232.1248174
10 + feature_95 -1 1.314243e+02        90  719.5810084  217.3498924
11 + feature_67 -1 1.120390e+02        89  607.5420383  202.4251186
12 + feature_47 -1 1.262323e+02        88  481.3097667  181.1340882
13 + feature_74 -1 1.379649e+02        87  343.3448914  149.3565270
14 + feature_65 -1 9.264802e+01        86  250.6968719  119.9074342
15 + feature_45 -1 5.614979e+01        85  194.5470820   96.5504015
16 + feature_93 -1 2.709000e+01        84  167.4570781   83.5556882
17 + feature_79 -1 2.186922e+01        83  145.5878579   71.5609553
18 + feature_80 -1 2.481389e+01        82  120.7739642   54.8750548
19 + feature_94 -1 2.681825e+01        81   93.9557116   31.7653332
20 + feature_21 -1 5.492370e+00        80   88.4633416   27.7418061
21 + feature_52 -1 3.749720e+00        79   84.7136218   25.4106226
22 + feature_19 -1 4.957195e+00        78   79.7564265   21.3807135
23 + feature_61 -1 3.164224e+00        77   76.5922026   19.3325092
24 + feature_20 -1 2.764881e+00        76   73.8273217   17.6558689
25 + feature_83 -1 3.371799e+00        75   70.4555224   14.9811437
26 + feature_98 -1 2.405872e+00        74   68.0496507   13.5067410
27 + feature_81 -1 3.176583e+00        73   64.8730680   10.7262374
28 + feature_16 -1 2.867790e+00        72   62.0052782    8.2049327
29 + feature_42 -1 2.315711e+00        71   59.6895669    6.3987061
30 + feature_37 -1 1.997896e+00        70   57.6916712    4.9942630
31 + feature_76 -1 2.234470e+00        69   55.4572009    3.0441383
32 + feature_24 -1 2.674053e+00        68   52.7831475    0.1021777
33 + feature_77 -1 2.287346e+00        67   50.4958014   -2.3279993
34  + feature_1 -1 2.120762e+00        66   48.3750391   -4.6186227
35 + feature_23 -1 2.212617e+00        65   46.1624222   -7.3004092
36 + feature_41 -1 2.093017e+00        64   44.0694054   -9.9404399
37  + feature_2 -1 1.940971e+00        63   42.1284348  -12.4447263
38 + feature_25 -1 1.668860e+00        62   40.4595747  -14.4866866
39 + feature_33 -1 1.984403e+00        61   38.4751713  -17.5157053
40  + feature_8 -1 2.075340e+00        60   36.3998312  -21.0606048
41 + feature_70 -1 1.905663e+00        59   34.4941680  -24.4379920
42  + feature_9 -1 1.912693e+00        58   32.5814748  -28.1426316
43 + feature_38 -1 1.417700e+00        57   31.1637750  -30.5913824
44 + feature_22 -1 1.389390e+00        56   29.7743850  -33.1521726
45 + feature_96 -1 1.483279e+00        55   28.2911061  -36.2622704
46 + feature_57 -1 1.617919e+00        54   26.6731870  -40.1511357
47 + feature_97 -1 7.773843e-01        53   25.8958027  -41.1089289
48 + feature_88 -1 7.133226e-01        52   25.1824801  -41.9021669
49 + feature_69 -1 9.930824e-01        51   24.1893977  -43.9255761
50 + feature_92 -1 5.395020e-01        50   23.6498957  -44.1811482
51 + feature_46 -1 6.673135e-01        49   22.9825822  -45.0433551
52 + feature_29 -1 6.496930e-01        48   22.3328892  -45.9109742
53 + feature_40 -1 6.354605e-01        47   21.6974286  -46.7976428
54  + feature_3 -1 5.849682e-01        46   21.1124604  -47.5306779
55 + feature_71 -1 6.048013e-01        45   20.5076591  -48.4371757
56 + feature_17 -1 8.207843e-01        44   19.6868747  -50.5218029
57 + feature_60 -1 6.309965e-01        43   19.0558782  -51.7794565
58 + feature_86 -1 7.256817e-01        42   18.3301965  -53.6620404
59 + feature_11 -1 6.108132e-01        41   17.7193833  -55.0511046
60 + feature_55 -1 4.595136e-01        40   17.2598696  -55.6786053
61 + feature_66 -1 6.577062e-01        39   16.6021634  -57.5637174
62 + feature_51 -1 8.763805e-01        38   15.7257829  -60.9868601
63 + feature_35 -1 1.779882e+00        37   13.9459006  -70.9984585
64 + feature_56 -1 9.941510e-01        36   12.9517496  -76.3939305
65 + feature_73 -1 8.046532e-01        35   12.1470964  -80.8080028
66 + feature_14 -1 4.178904e-01        34   11.7292060  -82.3088216
67 + feature_32 -1 3.791651e-01        33   11.3500409  -83.5948841
68 + feature_90 -1 2.565439e-01        32   11.0934970  -83.8811107
69 + feature_91 -1 3.745160e-01        31   10.7189810  -85.3154095
70 + feature_53 -1 3.695656e-01        30   10.3494154  -86.8240152
71  + feature_4 -1 3.870280e-01        29    9.9623874  -88.6353448
72 + feature_44 -1 4.190200e-01        28    9.5433674  -90.9323786
73 + feature_28 -1 2.990360e-01        27    9.2443314  -92.1159641
74 + feature_36 -1 3.113929e-01        26    8.9329385  -93.5424785
75 + feature_63 -1 2.965569e-01        25    8.6363816  -94.9186488
76 + feature_89 -1 4.331267e-01        24    8.2032549  -98.0639167
77 + feature_31 -1 4.932084e-01        23    7.7100466 -102.2645960
78 + feature_78 -1 4.577876e-01        22    7.2522590 -106.3857183
79 + feature_84 -1 3.420116e-01        21    6.9102474 -109.2164746
80 + feature_15 -1 3.134028e-01        20    6.5968446 -111.8578735
81 + feature_48 -1 3.546636e-01        19    6.2421810 -115.3840538
82 + feature_10 -1 3.554203e-01        18    5.8867607 -119.2464306
83 + feature_39 -1 2.745225e-01        17    5.6122382 -122.0220573
84 + feature_62 -1 3.360910e-01        16    5.2761473 -126.1974035
85 + feature_30 -1 3.687363e-01        15    4.9074110 -131.4423670
86 + feature_59 -1 4.749905e-01        14    4.4324205 -139.6224360
87 + feature_43 -1 5.045574e-01        13    3.9278631 -149.7074646
88 + feature_50 -1 4.714386e-01        12    3.4564245 -160.4935508
89 + feature_68 -1 5.513781e-01        11    2.9050465 -175.8720806
90  + feature_5 -1 3.013878e-01        10    2.6036586 -184.8252562
91 + feature_34 -1 4.581773e-01         9    2.1454814 -202.1806252
92 + feature_85 -1 4.911753e-01         8    1.6543061 -226.1788560
93 + feature_87 -1 4.920630e-01         7    1.1622431 -259.4818367
94 + feature_18 -1 1.688091e-01         6    0.9934340 -273.1757824
95 + feature_82 -1 2.350218e-01         5    0.7584122 -298.1698434
96 + feature_54 -1 3.189787e-01         4    0.4394335 -350.7439103
97  + feature_7 -1 1.494390e-01         3    0.2899945 -390.3063573
98 + feature_12 -1 7.687301e-02         2    0.2131215 -419.1063176
99 + feature_58 -1 1.056284e-01         1    0.1074931 -485.5498732
~~~
{: .output}



~~~
plot(coef(forward), beta[names(coef(forward))])
abline(0, 1)
abline(v = 0, lty = "dashed", col = "firebrick")
abline(h = 0, lty = "dashed", col = "firebrick")
~~~
{: .language-r}

<img src="../fig/rmd-02b-unnamed-chunk-5-1.png" title="plot of chunk unnamed-chunk-5" alt="plot of chunk unnamed-chunk-5" width="612" style="display: block; margin: auto;" />


~~~
## note about backward/both, not a challenge
all <- lm(y ~ . + 0, data = xy)
backward <- step(
    all,
    scope = formula(all),
    direction = "backward",
    trace = 0
)
backward$anova
~~~
{: .language-r}



~~~
          Step Df     Deviance Resid. Df Resid. Dev       AIC
1              NA           NA         1  0.1074931 -485.5499
2 - feature_79  1 0.0001645713         2  0.1076577 -487.3969
3 - feature_62  1 0.0009570764         3  0.1086148 -488.5118
4 - feature_18  1 0.0004859949         4  0.1091008 -490.0654
~~~
{: .output}



~~~
plot(coef(backward), beta[names(coef(backward))])
abline(0, 1)
abline(v = 0, lty = "dashed", col = "firebrick")
abline(h = 0, lty = "dashed", col = "firebrick")
~~~
{: .language-r}

<img src="../fig/rmd-02b-unnamed-chunk-6-1.png" title="plot of chunk unnamed-chunk-6" alt="plot of chunk unnamed-chunk-6" width="612" style="display: block; margin: auto;" />


{% include links.md %}
