---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 02-high-dimensional-regression_b.md in _episodes_rmd/
title: "Stepwise feature selection for regression"
teaching: 0
exercises: 0
questions:
- "Why would we want to find a subset of features
  that are associated with an outcome?"
- "How can we iteratively find a good subset of our features
  variables to use for regression?"
- "What are some risks and downsides of iterative feature
  selection?"
objectives:
- "Understand multiple regression in a biomedical context."
- "Understand how to fit a stepwise regression model."
keypoints:
- "Sets of features can be more predictive and provide
  a better explanation than a single feature alone."
- "Stepwise regression allows us to find a set of features that
  are associated with an outcome (eg, age)."
- "Stepwise regression will tend to retain only one
  feature out of many that are correlated."
- "Stepwise regression is not very efficient."
math: yes
---





In the previous 

Another way of modelling these data is to model age as 

$$
    y_j = \beta_0 + \beta_1 X_1 + \dots \beta_p X_p + \epsilon_j
$$



~~~
suppressPackageStartupMessages({
    library("glmnet")
    library("limma")
    library("minfi")
    library("here")
    library("broom")
})

if (!file.exists(here("data/methylation.rds"))) {
    source(here("data/methylation.R"))
}
norm <- readRDS(here("data/methylation.rds"))

lim <- norm
y <- lim$Age
X <- getM(lim)
~~~
{: .language-r}

However when the number of predictors is greater than the number of samples
(basically always true in genetics) it isn't possible to include everything!

There are some techniques that you can use to find a set of predictors!

- screening (correlation etc): bad, don't do
- screening (variance): not necessarily bad if the screening variable is sensible
- forward/reverse/best subset selection


~~~
if (!file.exists(here("data/synthetic.rds"))) {
    source(here("data/synthetic.R"))
}
synthetic <- readRDS(here("data/synthetic.rds"))
~~~
{: .language-r}





~~~
X <- assay(synthetic)
y <- synthetic$age
beta <- rowData(synthetic)$true_beta
names(beta) <- rownames(synthetic)
## challenge 3: fit y on x univariate
## compare with true betas
cc <- sapply(seq_len(nrow(X)), function(i) {
    coef(lm(y ~ X[i, ]))[[2]]
})
plot(cc, beta, pch = 19, cex = 0.5)
abline(0, 1)
abline(v = 0, lty = "dashed", col = "firebrick")
abline(h = 0, lty = "dashed", col = "firebrick")
~~~
{: .language-r}

<img src="../fig/rmd-02b-unnamed-chunk-4-1.png" title="plot of chunk unnamed-chunk-4" alt="plot of chunk unnamed-chunk-4" width="612" style="display: block; margin: auto;" />




> ## Exercise
> Perform forward subset selection on the methylation data.
> 
> 
> > ## Solution
> > 
> > 
> {: .solution}
{: .challenge}




~~~
## challenge 4: forward selection
## compare with true betas
xy <- as.data.frame(cbind(t(X), y = y))
int <- lm(y ~ 1, data = xy)
all <- lm(y ~ . + 0, data = xy)
forward <- step(
    int,
    scope = list(upper = formula(all), lower = formula(int)),
    direction = "forward",
    trace = 0
)
forward$anova
~~~
{: .language-r}



~~~
           Step Df     Deviance Resid. Df  Resid. Dev          AIC
1               NA           NA        99 4671.640000  386.4095281
2  + feature_96 -1 1178.7041631        98 3492.935837  359.3327690
3  + feature_69 -1  855.6853106        97 2637.250526  333.2322000
4  + feature_46 -1  611.4527187        96 2025.797808  308.8548695
5  + feature_67 -1  427.8361565        95 1597.961651  287.1313942
6  + feature_97 -1  344.2895127        94 1253.672138  264.8662048
7  + feature_90 -1  344.1665540        93  909.505584  234.7730952
8  + feature_17 -1  216.3593842        92  693.146200  209.6070758
9  + feature_71 -1  161.4003544        91  531.745846  185.0995456
10 + feature_84 -1  138.9315621        90  392.814284  156.8166754
11 + feature_80 -1  105.2547754        89  287.559508  127.6259638
12 + feature_86 -1   97.0076221        88  190.551886   88.4754340
13 + feature_62 -1   88.0543652        87  102.497521   28.4668427
14 + feature_70 -1    6.9984559        86   95.499065   23.3946272
15 + feature_60 -1    5.8100292        85   89.689036   19.1178345
16 + feature_61 -1    6.7681714        84   82.920865   13.2716528
17 + feature_48 -1    3.8630972        83   79.057767   10.5008632
18 + feature_56 -1    4.6153573        82   74.442410    6.4855621
19 + feature_66 -1    3.2539495        81   71.188461    4.0160549
20 + feature_59 -1    2.7895155        80   68.398945    2.0187216
21  + feature_6 -1    2.4757243        79   65.923221    0.3320557
22 + feature_26 -1    3.2337045        78   62.689516   -2.6975956
23  + feature_4 -1    3.5460780        77   59.143438   -6.5204535
24 + feature_68 -1    2.3072584        76   56.836180   -8.4997093
25 + feature_10 -1    2.1564595        75   54.679720  -10.3677288
26 + feature_54 -1    1.6586278        74   53.021093  -11.4480378
27 + feature_13 -1    1.5956694        73   51.425423  -12.5037522
28 + feature_51 -1    2.1657878        72   49.259635  -14.8065196
29 + feature_47 -1    1.2558783        71   48.003757  -15.3890907
30 + feature_41 -1    1.4499212        70   46.553836  -16.4560784
31 + feature_57 -1    1.4578620        69   45.095974  -17.6377215
32 + feature_44 -1    1.7559638        68   43.340010  -19.6093957
33 + feature_92 -1    1.2885990        67   42.051411  -20.6277243
34  + feature_9 -1    1.5009404        66   40.550471  -22.2622798
35 + feature_83 -1    1.0757351        65   39.474736  -22.9509324
36  + feature_1 -1    1.2132773        64   38.261458  -24.0727108
37 + feature_37 -1    1.3370372        63   36.924421  -25.6297035
38 + feature_15 -1    1.7025905        62   35.221831  -28.3504108
39 + feature_82 -1    1.2414603        61   33.980370  -29.9387171
40 + feature_58 -1    0.9654179        60   33.014952  -30.8209623
41 + feature_23 -1    1.0189498        59   31.996003  -31.9559210
42 + feature_52 -1    1.3306421        58   30.665360  -34.2036491
43 + feature_50 -1    1.5848635        57   29.080497  -37.5102444
44 + feature_24 -1    1.0568179        56   28.023679  -39.2120350
45 + feature_45 -1    0.9054233        55   27.118256  -40.4963040
46 + feature_20 -1    0.8815900        54   26.236666  -41.8012297
47 + feature_30 -1    0.9265662        53   25.310100  -43.3966676
48 + feature_16 -1    0.6168669        52   24.693233  -43.8640959
49 + feature_11 -1    0.6601978        51   24.033035  -44.5740846
50 + feature_93 -1    0.7183143        50   23.314721  -45.6085237
51 + feature_14 -1    0.8085944        49   22.506126  -47.1382635
52  + feature_8 -1    0.7168718        48   21.789255  -48.3753250
53 + feature_22 -1    0.5267084        47   21.262546  -48.8223062
54 + feature_98 -1    0.6754121        46   20.587134  -50.0503871
55 + feature_91 -1    0.7381057        45   19.849028  -51.7015134
56 + feature_64 -1    0.9100899        44   18.938938  -54.3950155
57 + feature_21 -1    0.9619658        43   17.976973  -57.6078549
58 + feature_18 -1    1.0937733        42   16.883199  -61.8851188
59 + feature_43 -1    0.8270982        41   16.056101  -64.9081280
60 + feature_19 -1    0.8488427        40   15.207258  -68.3397351
61 + feature_25 -1    0.7730464        39   14.434212  -71.5568970
62 + feature_32 -1    0.6449806        38   13.789231  -74.1282240
63 + feature_89 -1    0.9435232        37   12.845708  -79.2160429
64 + feature_39 -1    0.6507321        36   12.194976  -82.4146120
65 + feature_35 -1    0.4248791        35   11.770097  -83.9608028
66 + feature_73 -1    0.5887211        34   11.181376  -87.0920664
67 + feature_40 -1    0.4034218        33   10.777954  -88.7667436
68 + feature_29 -1    0.3824741        32   10.395480  -90.3799102
69 + feature_49 -1    0.3889131        31   10.006567  -92.1928634
70 + feature_74 -1    0.3933342        30    9.613233  -94.2029650
71  + feature_3 -1    0.5346118        29    9.078621  -97.9247909
72 + feature_87 -1    0.5594544        28    8.519166 -102.2851696
73  + feature_5 -1    0.4255679        27    8.093598 -105.4096756
74 + feature_65 -1    0.2942525        26    7.799346 -107.1130311
75 + feature_28 -1    0.3200412        25    7.479305 -109.3030345
76 + feature_55 -1    0.3999206        24    7.079384 -112.7983259
77 + feature_38 -1    0.1984916        23    6.880893 -113.6421803
78 + feature_75 -1    0.3289253        22    6.551967 -116.5404822
79 + feature_42 -1    0.5503459        21    6.001621 -123.3140504
80 + feature_36 -1    0.3220735        20    5.679548 -126.8298540
81  + feature_2 -1    0.2093783        19    5.470170 -128.5860550
82 + feature_34 -1    0.2720874        18    5.198082 -131.6880427
83 + feature_31 -1    0.1992490        17    4.998833 -133.5965657
84 + feature_95 -1    0.1665754        16    4.832258 -134.9856380
85 + feature_77 -1    0.1700225        15    4.662235 -136.5675190
86 + feature_63 -1    0.1186401        14    4.543595 -137.1451602
~~~
{: .output}



~~~
plot(coef(forward), beta[names(coef(forward))])
abline(0, 1)
abline(v = 0, lty = "dashed", col = "firebrick")
abline(h = 0, lty = "dashed", col = "firebrick")
~~~
{: .language-r}

<img src="../fig/rmd-02b-unnamed-chunk-5-1.png" title="plot of chunk unnamed-chunk-5" alt="plot of chunk unnamed-chunk-5" width="612" style="display: block; margin: auto;" />


~~~
## note about backward/both, not a challenge
all <- lm(y ~ . + 0, data = xy)
backward <- step(
    all,
    scope = formula(all),
    direction = "backward",
    trace = 0
)
backward$anova
~~~
{: .language-r}



~~~
          Step Df     Deviance Resid. Df Resid. Dev       AIC
1              NA           NA         1   3.377245 -140.8110
2 - feature_96  1 0.0004721513         2   3.377718 -142.7970
3 - feature_67  1 0.0171580102         3   3.394876 -144.2903
4 - feature_44  1 0.0245761298         4   3.419452 -145.5690
5 - feature_93  1 0.0175421835         5   3.436994 -147.0573
6  - feature_5  1 0.0097358470         6   3.446730 -148.7744
~~~
{: .output}



~~~
plot(coef(backward), beta[names(coef(backward))])
abline(0, 1)
abline(v = 0, lty = "dashed", col = "firebrick")
abline(h = 0, lty = "dashed", col = "firebrick")
~~~
{: .language-r}

<img src="../fig/rmd-02b-unnamed-chunk-6-1.png" title="plot of chunk unnamed-chunk-6" alt="plot of chunk unnamed-chunk-6" width="612" style="display: block; margin: auto;" />


{% include links.md %}
